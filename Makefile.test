#!/bin/bash

#-----------------------|DOCUMENTATION|-----------------------#
# @descr: Script to test the Makefile
# @fonts: 	
# @example:
#       bash Makefile.test plan
#    OR
#       bash Makefile.test compile
#-------------------------------------------------------------#

# @descr: Main function of the script, it runs automatically on the script call.
# @param: 
#    $@ | array: (*)
function MakefileTest {
    local coreos_release="stable";
    local coreos_version="1632.3.0";

    local template="coreos-virtualbox-template.json";
    local variables="vars-global.json vars-coreos.json vars-virtualbox.json vars-custom.json";
    local packer_only="virtualbox-iso";

    local ARG_COREOS="COREOS_RELEASE='${coreos_release}' COREOS_VERSION='${coreos_version}'";
    local ARG_PACKER="PACKER_TEMPLATE='${template}' PACKER_VARIABLES='${variables}' PACKER_ONLY='${packer_only}'";

    case "$@" in
        plan) {
            sh -c "make plan ${ARG_PACKER} ${ARG_COREOS}";

        };;
        compile) {
            bash -c "make plan compile ${ARG_PACKER} ${ARG_COREOS}";

        };;
        validate) {
            bash -c "make plan validate ${ARG_PACKER} ${ARG_COREOS}";

        };;
        build) {
            bash -c "make plan build ${ARG_PACKER} ${ARG_COREOS}";

        };;
        build-force) {
            bash -c "make build-force ${ARG_PACKER} ${ARG_COREOS}";

        };;
        install-box) {
            bash -c "make plan install-box ${ARG_PACKER} ${ARG_COREOS}";

        };;
        publish-box) {
            bash -c "make plan publish-box ${ARG_PACKER} ${ARG_COREOS}";

        };;
        uninstall-box) {
            bash -c "make plan uninstall-box ${ARG_PACKER} ${ARG_COREOS}";

        };;
        clean) {
            bash -c "make plan clean ${ARG_PACKER} ${ARG_COREOS}";

        };;
        *) {
            echo "WARNING: The test type has not been passed or is incorrect.";
        };;
    esac
}


# @descr: Create folder for log.
mkdir -p "${PWD}/builds";

# @descr: Call of execution of the script's main function.
MakefileTest "$@" 2>&1 | tee "${PWD}/builds/Makefile.test.log";

# @descr: Finishing the script!!! :P
exit 0;