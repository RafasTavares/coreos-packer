
#FONTS: https://github.com/coreos/bugs/issues/469#issuecomment-300817774

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-rsa AAAA...

update:
  group: stable

systemd:
  units:
    # enable iptables
    - name: iptables-restore.service
      enable: true

    # install docker-compose
    - name: install-docker-compose.service
      enable: true
      contents: |
        [Unit]
        Description=Install docker-compose

        [Service]
        Type=oneshot

        # create /opt/bin directory
        ExecStart=/usr/bin/mkdir -p /opt/bin/

        # sleep 2 seconds
        ExecStart=/usr/bin/sleep 2

        # get docker-compose from github
        # -q quiet
        # -nc don't fetch if file already exists (return 0)
        ExecStart=/bin/wget -q -nc -O /opt/bin/docker-compose "https://github.com/docker/compose/releases/download/1.13.0/docker-compose-linux-x86_64"

        # set execution rights
        ExecStart=/usr/bin/chmod +x /opt/bin/docker-compose

storage:
  files:
    # write iptables rules
    - filesystem: root
      path: /var/lib/iptables/rules-save
      mode: 0644
      user: 
        id: 0
      group:
        id: 0
      contents:
        inline: |
          *filter
          :INPUT DROP [0:0]
          :FORWARD DROP [0:0]
          :OUTPUT ACCEPT [0:0]

          # Accept all loopback (local) traffic:
          -A INPUT -i lo -j ACCEPT

          # Accept all CoreOS cluster traffic
          #-A INPUT -i eth1 -j ACCEPT

          # Accept all traffic on the local network from other members of
          # our CoreOS cluster:
          #-A INPUT -i eth1 -p tcp -s coreos-1_private_ip -j ACCEPT
          #-A INPUT -i eth1 -p tcp -s coreos-2_private_ip -j ACCEPT
          #-A INPUT -i eth1 -p tcp -s coreos-3_private_ip -j ACCEPT

          # Keep existing connections (like our SSH session) alive:
          -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

          # Accept all TCP/IP traffic to SSH, HTTP, and HTTPS ports
          -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
          -A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
          -A INPUT -p tcp -m tcp --dport 443 -j ACCEPT

          # Accept pings:
          -A INPUT -p icmp -m icmp --icmp-type 0 -j ACCEPT
          -A INPUT -p icmp -m icmp --icmp-type 3 -j ACCEPT
          -A INPUT -p icmp -m icmp --icmp-type 11 -j ACCEPT
          COMMIT
