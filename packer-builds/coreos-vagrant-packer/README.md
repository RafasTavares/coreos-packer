## Project generated through [coreos-packer](https://github.com/alisonbuss/coreos-packer/).
# Documentation:
## [Packer Modules] used to generate the Packer Template.
##### Directory of Packer Modules: "./packer-modules"
```text
./packer-modules
├── builders
├── post-processors
├── provisioners
└── variables

4 directories

```
 
## New Model for Packer.
##### ./packer-new-model/coreos-vagrant.json 
```bash
{
    "packer_template": {
        "description": "CoreOS image for a Vagrant platform.",
        "variables": {
            "vagrant_cpus": "2", 
            "vagrant_memory": "2048",
            "vagrant_disk_size": "33666",
            "coreos_ignition_name": "coreos-ignition-for-virtualbox.json"
        },
        "list_variables": [
            "/variables/vars-global.json",
            "/variables/vars-coreos.json",
            "/variables/vars-vagrant.json"
        ],
        "builders": [
            "/builders/vagrant.json"
        ],
        "provisioners": [
            "/provisioners/shell-hello-world.json"
        ],
        "post_processors": [
            "/post-processors/vagrant-box.json"
        ],
        "min_packer_version": "1.1.3"
    }
}
```
 
## Files generated by the New Model Packer.
```text
./packer-builds/coreos-vagrant-packer
├── coreos-alpha-1632.0.0.iso
├── files
│   ├── ignitions
│   │   ├── coreos-ignition-for-azure.json
│   │   ├── coreos-ignition-for-digitalocean.json
│   │   ├── coreos-ignition-for-ec2.json
│   │   ├── coreos-ignition-for-gce.json
│   │   ├── coreos-ignition-for-packet.json
│   │   ├── coreos-ignition-for-virtualbox.json
│   │   └── coreos-ignition.json
│   └── vagrant_insecure_private_key
├── ignition-for-vagrant-up.json
├── packer-template
│   ├── coreos-vagrant-template.json
│   ├── coreos-vagrant-template-min.json
│   ├── vars-coreos.json
│   ├── vars-custom-variables.json
│   ├── vars-global.json
│   └── vars-vagrant.json
├── README.md
├── start-packer.sh
├── Vagrantfile
└── vagrant-instances.json

3 directories, 20 files

```
 
## Custom Variables of the New Model Packer:
#### vars-custom-variables.json
##### ./packer-builds/coreos-vagrant-packer/packer-template/vars-custom-variables.json
```json
{
  "vagrant_cpus": "2",
  "vagrant_memory": "2048",
  "vagrant_disk_size": "33666",
  "coreos_ignition_name": "coreos-ignition-for-virtualbox.json"
}
```
 
## List Variables of the New Model Packer:
##### ./packer-modules/variables/vars-global.json 
```json
{
    "global_working_directory": "/",
    
    "global_build_path": "/packer-builds",
    "global_provisioners_path": "/provisioners"
}
```
 
##### ./packer-modules/variables/vars-coreos.json 
```json
{
    "coreos_name": "coreos",
    "coreos_release": "stable",
    "coreos_version": "current",
    "coreos_ignition_path": "/files/ignitions/",
    "coreos_ignition_name": "coreos-ignition.json"
}
```
 
##### ./packer-modules/variables/vars-vagrant.json 
```json
{
    "vagrant_vm_name": "vm-coreos-packer",
    "vagrant_iso_checksum": "",
    "vagrant_iso_checksum_type": "none",
    "vagrant_insecure_private_key": "/files/vagrant_insecure_private_key",
    "vagrant_cpus": "1", 
    "vagrant_memory": "512",
    "vagrant_disk_size": "20000"
}
```
 
 
## Builders of the New Model Packer:
##### ./packer-modules/builders/vagrant.json 
```json
{
    "type": "virtualbox-iso",
        
    "vm_name": "{{user `vagrant_vm_name`}}",
    "iso_checksum": "{{user `vagrant_iso_checksum`}}",
    "iso_checksum_type": "{{user `vagrant_iso_checksum_type`}}",
    "iso_url": "http://{{user `coreos_release`}}.release.core-os.net/amd64-usr/{{user `coreos_version`}}/coreos_production_iso_image.iso",
    "iso_target_path": "{{user `global_build_path`}}/coreos-{{user `coreos_release`}}-{{user `coreos_version`}}.iso", 
    "guest_os_type": "Linux26_64",
    
    "hard_drive_interface": "sata",
    "disk_size": "{{user `vagrant_disk_size`}}",
    "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--memory", "{{user `vagrant_memory`}}"],
        ["modifyvm", "{{.Name}}", "--cpus", "{{user `vagrant_cpus`}}"]
    ],
    "http_directory": "{{user `global_build_path`}}",

    "headless": "false",
    "guest_additions_mode": "disable",
    "output_directory": "{{user `global_build_path`}}/packer-vm-cache",
    
    "boot_wait": "33s",
    "boot_command": [
        "sudo -i;<enter>",
        "systemctl stop sshd.socket;<enter>",
        "wget http://{{ .HTTPIP }}:{{ .HTTPPort }}{{user `coreos_ignition_path`}}{{user `coreos_ignition_name`}};<enter>",
        "cat {{user `coreos_ignition_name`}};<enter>",
        "coreos-install -d /dev/sda -C {{ user `coreos_release` }} -i {{user `coreos_ignition_name`}};<enter>",
        "sleep 3s;<enter>",
        "reboot;<enter>"
    ],  
    
    "communicator": "ssh",
    "ssh_port": 22,
    "ssh_username": "core",
    "ssh_private_key_file": "{{user `global_build_path`}}{{user `vagrant_insecure_private_key`}}",
    "ssh_timeout": "33m",

    "shutdown_command": "sudo -S shutdown -P now"
}
```
 
 
## Provisioners of the New Model Packer:
##### ./packer-modules/provisioners/shell-hello-world.json 
```json
{
    "type": "shell",
    "inline": ["echo 'Hello World!!!'", "echo 'Hello CoreOS!!!'"],
    "only": ["virtualbox-iso"]
}
```
 
 
## Post-Processors of the New Model Packer:
##### ./packer-modules/post-processors/vagrant-box.json 
```json
{
    "type": "vagrant",
    "compression_level": "6",
    "output": "{{user `global_build_path`}}/coreos-{{user `coreos_release`}}-{{user `coreos_version`}}.box"
}
```
 
 
## Packer Template generated through the New Model Packer:
#### coreos-vagrant-template.json
##### ./packer-builds/coreos-vagrant-packer/packer-template/coreos-vagrant-template.json
```json
{
  "description": "CoreOS image for a Vagrant platform.",
  "builders": [
    {
      "type": "virtualbox-iso",
      "vm_name": "{{user `vagrant_vm_name`}}",
      "iso_checksum": "{{user `vagrant_iso_checksum`}}",
      "iso_checksum_type": "{{user `vagrant_iso_checksum_type`}}",
      "iso_url": "http://{{user `coreos_release`}}.release.core-os.net/amd64-usr/{{user `coreos_version`}}/coreos_production_iso_image.iso",
      "iso_target_path": "{{user `global_build_path`}}/coreos-{{user `coreos_release`}}-{{user `coreos_version`}}.iso",
      "guest_os_type": "Linux26_64",
      "hard_drive_interface": "sata",
      "disk_size": "{{user `vagrant_disk_size`}}",
      "vboxmanage": [
        [
          "modifyvm",
          "{{.Name}}",
          "--memory",
          "{{user `vagrant_memory`}}"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--cpus",
          "{{user `vagrant_cpus`}}"
        ]
      ],
      "http_directory": "{{user `global_build_path`}}",
      "headless": "false",
      "guest_additions_mode": "disable",
      "output_directory": "{{user `global_build_path`}}/packer-vm-cache",
      "boot_wait": "33s",
      "boot_command": [
        "sudo -i;<enter>",
        "systemctl stop sshd.socket;<enter>",
        "wget http://{{ .HTTPIP }}:{{ .HTTPPort }}{{user `coreos_ignition_path`}}{{user `coreos_ignition_name`}};<enter>",
        "cat {{user `coreos_ignition_name`}};<enter>",
        "coreos-install -d /dev/sda -C {{ user `coreos_release` }} -i {{user `coreos_ignition_name`}};<enter>",
        "sleep 3s;<enter>",
        "reboot;<enter>"
      ],
      "communicator": "ssh",
      "ssh_port": 22,
      "ssh_username": "core",
      "ssh_private_key_file": "{{user `global_build_path`}}{{user `vagrant_insecure_private_key`}}",
      "ssh_timeout": "33m",
      "shutdown_command": "sudo -S shutdown -P now"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "echo 'Hello World!!!'",
        "echo 'Hello CoreOS!!!'"
      ],
      "only": [
        "virtualbox-iso"
      ]
    }
  ],
  "post-processors": [
    {
      "type": "vagrant",
      "compression_level": "6",
      "output": "{{user `global_build_path`}}/coreos-{{user `coreos_release`}}-{{user `coreos_version`}}.box"
    }
  ],
  "min_packer_version": "1.1.3"
}

```
 
## Execution script Packer CLI, generated through the New Model Packer:
#### start-packer.sh
##### ./packer-builds/coreos-vagrant-packer/start-packer.sh
```bash
#!/bin/bash
function StartPacker {
    local params="$@";
    local coreos_release="alpha";
    local coreos_version="1632.0.0";
    local coreos_url_digests="http://${coreos_release}.release.core-os.net/amd64-usr/${coreos_version}/coreos_production_iso_image.iso.DIGESTS";
    local iso_checksum_type="SHA512";
    local iso_checksum=$(wget -qO- "${coreos_url_digests}" | grep "coreos_production_iso_image.iso" | awk '{ print length, $1 | "sort -rg"}' | awk 'NR == 1 { print $2 }');
    local build_path="./packer-builds/coreos-vagrant-packer";
    local template_path="./packer-builds/coreos-vagrant-packer/packer-template";
    local template_file="${template_path}/coreos-vagrant-template-min.json";
    __run_packer() {
        # FONT: https://www.packer.io/docs/templates/user-variables.html#from-a-file
        packer "$@" \
			-var-file="${template_path}/vars-global.json" \
			-var-file="${template_path}/vars-coreos.json" \
			-var-file="${template_path}/vars-vagrant.json" \
            -var-file="${template_path}/vars-custom-variables.json" \
            -var "coreos_release=${coreos_release}" \
            -var "coreos_version=${coreos_version}" \
            -var "vagrant_iso_checksum_type=${iso_checksum_type}" \
            -var "vagrant_iso_checksum=${iso_checksum}" \
            -var "global_build_path=${build_path}" \
            "${template_file}";
    }
    case $params in
        validate) { __run_packer $params; };;
        inspect)  { packer inspect "${template_file}"; };;
        *build*)    { __run_packer $params; };;
        *)        { packer $params; };;
    esac
}
StartPacker "$@";
exit 0;

```
 
