{
    "builders": [{
        "type": "virtualbox-iso",
        
        "vm_name": "{{user `name`}}-{{user `release`}}-{{user `version`}}",
        "iso_url": "{{user `files_directory`}}/coreos-alpha-1618.0.0.iso",
        "guest_os_type": "Linux26_64",
        "output_directory": "packer-coreos-{{user `release`}}-{{user `version`}}-{{build_type}}", 

        "hard_drive_interface": "sata",
        "disk_size": "{{user `disk_size`}}",
        "vboxmanage": [
            ["modifyvm", "{{.Name}}", "--memory", "{{user `memory`}}"],
            ["modifyvm", "{{.Name}}", "--cpus", "{{user `cpus`}}"]
        ],
        "guest_additions_mode": "disable",
        "headless": "true",

        "ssh_port": 22,
        "ssh_username": "core",
        "ssh_private_key_file": "{{user `files_directory`}}/{{user `vagrant_insecure_private_key`}}",
        "http_directory": "{{user `files_directory`}}",
        
        "boot_command": [
            "wget -O ~/.ssh/authorized_keys http://{{ .HTTPIP }}:{{ .HTTPPort }}/{{user `files_directory`}}/{{user `vagrant_insecure_public_key`}}",
            "<enter>",
            "chmod 0600 ~/.ssh/authorized_keys",
            "<enter>",
            "sudo systemctl start sshd.service",
            "<enter>"
        ],
        "boot_wait": "33s",
        "shutdown_command": "echo 'packer' | sudo -S shutdown -P now"
    }],

    "provisioners": [
        {
            "type": "file",
            "source": "{{user `files_directory`}}/ignition.json",
            "destination": "/tmp/ignition.json"
        },
        {
            "type": "shell",
            "inline": [
                "sudo coreos-install -d /dev/vda -C {{ user `release` }} -i /tmp/ignition.json"
            ]
        }
    ],

    "post-processors": [{
        "type": "vagrant",
        "compression_level": "6",
        "output": "./builds/{{.Provider}}/{{user `vagrant_box_name`}}.box"
    }]
}